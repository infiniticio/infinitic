# Infinitic Worker for Apache Pulsar

The Infinitic worker executes workflows and tasks and sends result to the Infinitic Engine.

## Development

### Requirements

- Java JDK 8

### Building

```shell script
./gradlew build
```

You can find the build JAR files in the following directories:

- `./build/libs` for the Pulsar Function version of the engine
- `./build/distributions` for the standalone version of the engine

## Usage

### Setting up your project

This example guides you to properly setup a project with some very basic task and workflow implementations.
Because the Infinitic packages are not yet published, it is easier to create your new project directory at the
root of the Infinitic repository to ease declarations of dependencies.

```shell script
$ mkdir my-infinitic-project && cd my-infinitic-project
$ gradle init

Select type of project to generate:
  1: basic
  2: application
  3: library
  4: Gradle plugin
Enter selection (default: basic) [1..4] 2

Select implementation language:
  1: C++
  2: Groovy
  3: Java
  4: Kotlin
  5: Swift
Enter selection (default: Java) [1..5] 4

Select build script DSL:
  1: Groovy
  2: Kotlin
Enter selection (default: Kotlin) [1..2] 2

Project name (default: my-infinitic-project):
Source package (default: my.infinitic.project):

BUILD SUCCESSFUL in 20s
2 actionable tasks: 2 executed
```

Now add the new directory to the included projects in the main `settings.gradle.kts` file by adding these lines:

```kotlin
// settings.gradle.kts
include("my-infinitic-project")
```

We can now open the `build.gradle.kts` file of our new project to add the required dependencies:

```kotlin
// my-infinitic-project/build.gradle.kts

// Required
implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core:1.3.+")

// Required
implementation(project(":infinitic-pulsar"))

// Add this if you intend to deploy the worker as a standalone JVM application
implementation("org.apache.pulsar:pulsar-client:2.6.+")
// Add this if you intend to deploy the worker as a Pulsar Function
implementation("org.apache.pulsar:pulsar-functions-api:2.6.+")
```

And we also want to instruct Kotlin to target Java 8:

```kotlin
tasks.withType<org.jetbrains.kotlin.gradle.tasks.KotlinCompile> {
    kotlinOptions.jvmTarget = JavaVersion.VERSION_1_8.toString()
}
```

Now, in your `src/main/kotlin/my/infinitic/project/` directory, create a `workflows` and a `tasks` directories.
In the `tasks` directory we will write two very simple tasks: one adding numbers, and one multiplying numbers:

```kotlin
// src/main/kotlin/my/infinitic/project/tasks/Add.kt
package my.infinitic.project.tasks

interface Add {
    fun add(a: Int, b: Int): Int
}

class AddImpl : Add {
    override fun add(a: Int, b: Int): Int = a + b
}
```

```kotlin
// src/main/kotlin/my/infinitic/project/tasks/Multiply.kt
package my.infinitic.project.tasks

interface Multiply {
    fun multiply(a: Int, b: Int): Int
}

class MultiplyImpl : Multiply {
    override fun multiply(a: Int, b: Int): Int = a * b
}
```

In the previously created `workflows` directory, we will write the implementation of a simple workflow taking an integer
as its input, adding 10 to it and returning the result multiplied by 2 as its output.

```kotlin
// src/main/kotlin/my/infinitic/project/workflows/Add10AndMultiplyBy2.kt
package my.infinitic.project.workflows

import io.infinitic.common.workflows.Workflow
import io.infinitic.common.workflows.WorkflowTaskContext
import io.infinitic.common.workflows.proxy
import my.infinitic.project.tasks.Add
import my.infinitic.project.tasks.Multiply

interface Add10AndMultiplyBy2 : Workflow {
    fun handle(n: Int)
}

class Add10AndMultiplyBy2Impl : Add10AndMultiplyBy2 {
    override lateinit var context: WorkflowTaskContext

    override fun handle(n: Int): Int {
        val addTask = proxy(Add::class)
        val multiplyTask = proxy(Multiply::class)

        val nPlus10 = addTask.add(n, 10)

        return multiplyTask.multiply(nPlus10, 2)
    }
}
```

Finally, in the `App.kt` file that was generated by Gradle, we will replace the main function by the code needed to make
our worker run:

```kotlin
// src/main/kotlin/my/infinitic/project/App.kt
package my.infinitic.project

import io.infinitic.messaging.api.dispatcher.AvroDispatcher
import io.infinitic.messaging.pulsar.PulsarTransport
import io.infinitic.inMemory.main.worker
import kotlinx.coroutines.runBlocking
import my.infinitic.project.tasks.Add
import my.infinitic.project.tasks.AddImpl
import my.infinitic.project.tasks.Multiply
import my.infinitic.project.tasks.MultiplyImpl
import my.infinitic.project.workflows.Add10AndMultiplyBy2
import my.infinitic.project.workflows.Add10AndMultiplyBy2Impl
import org.apache.pulsar.client.api.PulsarClient

fun main(args: Array<String>) = runBlocking {
    val pulsarClient = PulsarClient.builder().serviceUrl("pulsar://localhost:6650").build()

    val dispatcher = AvroDispatcher(PulsarTransport.forPulsarClient(pulsarClient))

    val worker = worker(pulsarClient, dispatcher) {
        // In this block of code you need to register workflow and task implementations.
        // For every registration, you need to provide a lambda able to create a new instance of your implementation.
        register<Add10AndMultiplyBy2> { Add10AndMultiplyBy2Impl() }

        register<Add> { AddImpl() }
        register<Multiply> { MultiplyImpl() }
    }
    worker.run()
}
```

### Deployment

#### Standalone

By running `./gradlew build`, you will be able to find some archives in the `build/distributions` of the project.
Extract one of the archive somewhere and run `./bin/my-infinitic-project` to start the worker.
